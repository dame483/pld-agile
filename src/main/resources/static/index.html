<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Optimod’Lyon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<div class="navbar">
    <div class="navbar-left">
        <div class="navbar-item">
           <img src="tools/home.png" alt="Accueil" id="homeButton"/>
        </div>
        <div class="navbar-item">
            <img src="tools/map-logo.png" alt="Ajouter une carte"/>
        </div>
        <div class="navbar-item">
            <img src="tools/colis-logo-gray.png" alt="Ajouter une demande de livraison" class="disabled"/>
        </div>
        <div class="navbar-item">
            <img src="tools/open-logo.png" alt="Charger une tournée"/>
        </div>
    </div>
    <div class="navbar-logo">
        <img src="tools/logo.png" alt="Opti'Mod Lyon"/>
    </div>
</div>

<div id="welcome-message">
    <div class="main-text">
        <h1> La gestion de tournée à portée de clic ! </h1>
    </div>
    <div class="bulle">
        <h2> Commencez dès maintenant en chargeant une carte ! </h2>
    </div>
</div>

<div id="carte-chargee-message">
    <div class="bulle">
        <h2> Chargez à présent vos demandes de livraison ! </h2>
    </div>
</div>

<div class="carte">
    <div class="bandeau">
        <span id="fileNameCarte" style="display:none;"></span>
    </div>
    <input type="file" id="xmlCarte" accept=".xml" style="display:none;" />
</div>

<div class="livraisons">
    <div class="bandeau">
        <span id="fileNameDemande" style="display:none;"></span>
    </div>
    <input type="file" id="xmlDemande" accept=".xml" style="display:none;" disabled/>

    <div id="calcul-tournee">
        <div class="bloc-livreurs">
            <label for="nbLivreurs">Nombre de livreurs :</label>
            <input type="number" id="nbLivreurs" min="1" value="1">
        </div>

        <button id="calculerTournee">
            <img src="tools/tournee-logo.png" alt="Icône tournée">
            <p>Calculer les tournées optimales</p>
        </button>
    </div>


</div>

<div id="map"></div>
<script>
    let map=null;
    let carteData=null;
    const colors=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe'];

    async function uploadCarte(file){
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-carte",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            carteData=await response.json();
            drawCarte(carteData);
            const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');
            const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');

            mapButton.style.filter = "";
            colisButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";

            const inputDemande = document.getElementById('xmlDemande');
            const fileNameCarte = document.getElementById('fileNameCarte');
            colisButton.src = "tools/colis-logo-white.png";
            colisButton.style.cursor = "pointer";
            inputDemande.disabled = false;
            fileNameCarte.style.display = "inline";
            document.getElementById('welcome-message').style.display = "none";
            document.getElementById('carte-chargee-message').style.display = "flex";

        }
        catch(err){
            alert(err.message);
        }
    }

    async function uploadDemande(file){
        if(!carteData){alert("Charger le plan XML d'abord."); return;}
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-demande",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            const demande=await response.json();

            const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');
            colisButton.style.filter = "";

            const fileNameCarte = document.getElementById('fileNameCarte');
            fileNameCarte.style.display = "none";
            const fileNameDemande = document.getElementById('fileNameDemande');
            fileNameDemande.style.display = "inline";
            document.getElementById('carte-chargee-message').style.display = "none";
            document.getElementById('calcul-tournee').style.display = "flex";
            drawLivraisons(demande);
        }
        catch(err){
            alert(err.message);
        }
    }

    function drawCarte(carte){
        const nodes=carte.noeuds||{};
        const troncons=carte.troncons||[];
        const mapDiv=document.getElementById('map');
        mapDiv.style.display="block";
        if(!map){
            map=L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);
        }else{
            map.eachLayer(layer=>{if(layer instanceof L.Polyline||layer instanceof L.CircleMarker||layer instanceof L.Marker) map.removeLayer(layer);});
        }
        troncons.forEach(t=>{
            const origine=nodes[t.idOrigine.toString()];
            const dest=nodes[t.idDestination.toString()];
            if(!origine||!dest) return;
            L.polyline([[origine.latitude,origine.longitude],[dest.latitude,dest.longitude]],{color:'#1a74bb',weight:2}).addTo(map);
        });
        const allLatLngs=Object.values(nodes).map(n=>[n.latitude,n.longitude]);
        if(allLatLngs.length>0) map.fitBounds(L.latLngBounds(allLatLngs).pad(0.1));
    }

    function drawLivraisons(demande){
        if(!map) return;
        const nodes=carteData.noeuds||{};
        let colorIndex=0;
        demande.livraisons.forEach(livraison=>{
            const color=colors[colorIndex%colors.length];
            colorIndex++;
            const enlevNode=nodes[livraison.adresseEnlevement.id.toString()];
            const livrNode=nodes[livraison.adresseLivraison.id.toString()];
            if(!enlevNode||!livrNode) return;
            L.marker([enlevNode.latitude, enlevNode.longitude], {
                icon: L.divIcon({
                    className: 'square-marker',
                    iconSize: [16, 16],
                    html: `<div style="width:16px; height:16px; background:${color}; border:2px solid black;"></div>`
                })
            }).addTo(map).bindPopup(`Enlèvement : ${livraison.adresseEnlevement.id}`);
            L.circleMarker([livrNode.latitude, livrNode.longitude],{color:'black',fillColor:color,radius:8,fillOpacity:0.8}).addTo(map).bindPopup(`Livraison : ${livraison.adresseLivraison.id}`);
        });
    }

    document.addEventListener('DOMContentLoaded',()=>{
        const inputCarte = document.getElementById('xmlCarte');
        const inputDemande = document.getElementById('xmlDemande');

        const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');
        const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');

        mapButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";
        mapButton.addEventListener('click', () => {
            inputCarte.click();
        });
        colisButton.addEventListener('click', () => {
            if (!inputDemande.disabled) {
                inputDemande.click();
            }
        });

        document.getElementById('xmlCarte').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('fileNameCarte').textContent = file ? `Affichage de ${file.name}` : "";
            if (file) uploadCarte(file);
        });

        document.getElementById('xmlDemande').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('fileNameDemande').textContent = file ? `Affichage de ${file.name}` : "";
            if (file) uploadDemande(file);
        });

        document.getElementById('homeButton').addEventListener('click', () => {
            const confirmReset = confirm("Voulez-vous vraiment revenir à la page d’accueil ? Toutes les données chargées seront perdues.");

            if (confirmReset) {
                carteData = null;
                map = null;

                const mapDiv = document.getElementById('map');
                mapDiv.style.display = "none";
                mapDiv.innerHTML = "";

                document.getElementById('xmlCarte').value = "";
                document.getElementById('xmlDemande').value = "";
                document.getElementById('xmlDemande').disabled = true;

                document.getElementById('fileNameCarte').style.display = "none";
                document.getElementById('fileNameDemande').style.display = "none";
                document.getElementById('carte-chargee-message').style.display = "none";
                document.getElementById('welcome-message').style.display = "flex";

                const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');
                const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');

                mapButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";
                colisButton.src = "tools/colis-logo-gray.png";
                colisButton.style.filter = "";
                colisButton.style.cursor = "default";

                document.getElementById('calcul-tournee').style.display = "none";
            }
        });
    });
</script>
</body>
</html>