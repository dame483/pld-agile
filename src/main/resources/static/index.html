<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Optimod’Lyon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; text-align: center; background-color: #a6a6a6; }
        #map { width: 100%; max-width: 1000px; height: 600px; margin: 20px auto; border: 1px solid #ccc; display: none; }
        .file-label { display: inline-block; background-color: #b2d1d2; margin-right: 10px; font-size: 16px; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: white; border: none; }
        .file-label:hover { background-color: #a0bcbd; }
        .file-container { display: inline-block; position: relative; margin-bottom: 10px; }
        #fileNameCarte, #fileNameDemande { position: absolute; bottom: -18px; left: 0; font-size: 12px; color: black; }
    </style>
</head>
<body>
<h1>Optimod’Lyon</h1>
<div class="file-container">
    <label for="xmlCarte" class="file-label">Charger une carte</label>
    <input type="file" id="xmlCarte" accept=".xml" style="display:none;" />
    <span id="fileNameCarte"></span>
</div>
<div class="file-container">
    <label for="xmlDemande" class="file-label" id="labelDemande" style="background-color:#999; cursor:not-allowed;">Charger une demande</label>
    <input type="file" id="xmlDemande" accept=".xml" style="display:none;" disabled />
    <span id="fileNameDemande"></span>
</div>
<div id="map"></div>
<script>
    let map=null;
    let carteData=null;
    const colors=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe'];

    async function uploadCarte(file){
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-carte",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            rep=await response.json();
            carteData=rep.carte;
            drawCarte(carteData);
            document.getElementById('xmlDemande').disabled=false;
            document.getElementById('labelDemande').style.backgroundColor="#b2d1d2";
            document.getElementById('labelDemande').style.cursor="pointer";
        }catch(err){alert(err.message);}
    }

    async function uploadDemande(file){
        if(!carteData){alert("Charger le plan XML d'abord."); return;}
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-demande",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            const demande=await response.json();
            drawLivraisons(demande);
        }catch(err){alert(err.message);}
    }

    function drawCarte(carte){
        const nodes=carte.noeuds||{};
        const troncons=carte.troncons||[];
        const mapDiv=document.getElementById('map');
        mapDiv.style.display="block";
        if(!map){
            map=L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);
        }else{
            map.eachLayer(layer=>{if(layer instanceof L.Polyline||layer instanceof L.CircleMarker||layer instanceof L.Marker) map.removeLayer(layer);});
        }
        troncons.forEach(t=>{
            const origine=nodes[t.idOrigine.toString()];
            const dest=nodes[t.idDestination.toString()];
            if(!origine||!dest) return;
            L.polyline([[origine.latitude,origine.longitude],[dest.latitude,dest.longitude]],{color:'#1a74bb',weight:2}).addTo(map);
        });
        const allLatLngs=Object.values(nodes).map(n=>[n.latitude,n.longitude]);
        if(allLatLngs.length>0) map.fitBounds(L.latLngBounds(allLatLngs).pad(0.1));
    }

    function drawLivraisons(demande){
        if(!map) return;
        const nodes=carteData.noeuds||{};
        let colorIndex=0;
        demande.livraisons.forEach(livraison=>{
            const color=colors[colorIndex%colors.length];
            colorIndex++;
            const enlevNode=nodes[livraison.adresseEnlevement.id.toString()];
            const livrNode=nodes[livraison.adresseLivraison.id.toString()];
            if(!enlevNode||!livrNode) return;
            L.marker([enlevNode.latitude, enlevNode.longitude], {
                icon: L.divIcon({
                    className: 'square-marker',
                    iconSize: [16, 16],
                    html: `<div style="width:16px; height:16px; background:${color}; border:2px solid black;"></div>`
                })
            }).addTo(map).bindPopup(`Enlèvement : ${livraison.adresseEnlevement.id}`);
            L.circleMarker([livrNode.latitude, livrNode.longitude],{color:'black',fillColor:color,radius:8,fillOpacity:0.8}).addTo(map).bindPopup(`Livraison : ${livraison.adresseLivraison.id}`);
        });
    }

    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('xmlCarte').addEventListener('change',function(){
            const file=this.files[0];
            document.getElementById('fileNameCarte').textContent=file?file.name:"";
            if(file) uploadCarte(file);
        });
        document.getElementById('xmlDemande').addEventListener('change',function(){
            const file=this.files[0];
            document.getElementById('fileNameDemande').textContent=file?file.name:"";
            if(file) uploadDemande(file);
        });
    });
</script>
</body>
</html>