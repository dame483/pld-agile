<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Optimodâ€™Lyon</title>
    <link rel="icon" type="image/x-icon" href="tools/favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<div class="navbar">
    <div class="navbar-left">
        <div class="navbar-item">
           <img src="tools/home.png" alt="Accueil" id="homeButton"/>
        </div>
        <div class="navbar-item">
            <img src="tools/map-logo.png" alt="Ajouter une carte"/>
        </div>
        <div class="navbar-item">
            <img src="tools/colis-logo-gray.png" alt="Ajouter une demande de livraison" class="disabled"/>
        </div>
        <div class="navbar-item">
            <img src="tools/open-logo.png" alt="Charger une tournÃ©e"/>
        </div>
    </div>
    <div class="navbar-logo">
        <img src="tools/logo.png" alt="Opti'Mod Lyon"/>
    </div>
</div>

<div id="welcome-message">
    <div class="main-text">
        <h1> La gestion de tournÃ©e Ã  portÃ©e de clic ! </h1>
    </div>
    <div class="bulle">
        <h2> Commencez dÃ¨s maintenant en chargeant une carte ! </h2>
    </div>
</div>

<div id="carte-chargee-message">
    <div class="bulle">
        <h2> Chargez Ã  prÃ©sent vos demandes de livraison ! </h2>
    </div>
</div>

<div class="carte">
    <div class="bandeau">
        <span id="fileNameCarte" style="display:none;"></span>
    </div>
    <input type="file" id="xmlCarte" accept=".xml" style="display:none;" />
</div>

<div id="livraisons">
    <div class="bandeau">
        <span id="fileNameDemande" style="display:none;"></span>
    </div>


    </div>
    <input type="file" id="xmlDemande" accept=".xml" style="display:none;" disabled/>

    <div id="calcul-tournee">
        <div class="bloc-livreurs">
            <label for="nbLivreurs">Nombre de livreurs :</label>
            <input type="number" id="nbLivreurs" min="1" value="1" max="1">
            <!-- max 1 for the moment-->
        </div>

        <button id="calculerTournee">
            <img src="tools/tournee-logo.png" alt="IcÃ´ne tournÃ©e">
            <p>Calculer les tournÃ©es optimales</p>
        </button>
    </div>
</div>

<div id="tournee-chargee">
    <div class="bandeau">
        <span>Affichage des tournÃ©es</span>
    </div>
    <div id="boutons-modifier">
        <button id="modifierTournee">
            <img src="tools/edit-logo.png" alt="IcÃ´ne modifier tournÃ©e">
            <p>Modifier</p>
        </button>
        <button id="sauvegarderTournee">
            <img src="tools/save-logo.png" alt="IcÃ´ne sauvegarder tournÃ©e">
            <p>Sauvegarder</p>
        </button>
        <button id="creerFeuillesDeRoute">
            <img src="tools/file-logo.png" alt="IcÃ´ne crÃ©er feuilles de route">
            <p>Feuilles de route</p>
        </button>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    <div class="tableau" id="tableauDemandes" style="display:none;"></div>
</div>
<script>
    let map=null, carteData=null, demandeData=null;
    let livraisonsLayer=null, entrepotLayer=null;
    let animTimer=null, courierMarker=null, animPath=[];
    let animControl=null, isAnimating=false, isPaused=false;
    let animSpeed=8, animSamples=[], animIndex=0;

    const colors=[
      '#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0',
      '#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8',
      '#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080','#000000'
    ];
    const STEP_M=10;

    async function uploadCarte(file){
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-carte",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            const res=await response.json();
            carteData = res.carte;
            demandeData = null;

            drawCarte(carteData);

            const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');
            const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');

            mapButton.style.filter = "";
            colisButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";
            colisButton.src = "tools/colis-logo-white.png";
            colisButton.style.cursor = "pointer";

            document.getElementById('welcome-message').style.display = "none";
            document.getElementById('carte-chargee-message').style.display = "flex";
            document.getElementById('livraisons').style.display = "none";
            tableau = document.getElementById('tableauDemandes');
            tableau.style.display = "none";
            tableau.innerHTML = "";
            document.getElementById('tournee-chargee').style.display = "none";

            // vider les layers de livraisons / entrepÃ´t / tournÃ©e / numÃ©ros
            if (livraisonsLayer) livraisonsLayer.clearLayers();
            if (entrepotLayer) entrepotLayer.clearLayers();
            if (window.tourneeLayer) window.tourneeLayer.clearLayers();
            if (window.directionNumbersLayer) window.directionNumbersLayer.clearLayers();

            // arrÃªter et enlever l'animation si prÃ©sente
            stopAnimation();
            if (animControl) { map.removeControl(animControl); animControl = null; }
            animPath = []; isAnimating = false; isPaused = false;

            // 4) activer/dÃ©sactiver l'input demande selon le nouvel Ã©tat renvoyÃ© (optionnel)
            // si le backend renvoie "Etat Carte Chargee", on garde le champ demande activÃ©
            if (res.etatCourant && res.etatCourant.toLowerCase().includes("carte")) {
                document.getElementById('xmlDemande').disabled = false;
                document.getElementById('fileNameCarte').style.display = "inline";
            } else {
                document.getElementById('xmlDemande').disabled = true;
                document.getElementById('fileNameCarte').style.display = "none";
            }
        }catch(err){
            alert(err.message);
        }
    }
}


    async function uploadDemande(file){
        resetTournee();
        if(!carteData){alert("Charger le plan XML d'abord."); return;}
        const formData=new FormData();
        formData.append("file",file);
        try{
            const response=await fetch("http://localhost:8080/api/upload-demande",{method:"POST",body:formData});
            if(!response.ok){alert(await response.text());return;}
            const res=await response.json();
            demandeData = res.demande;
            document.getElementById('livraisons').style.display = "inline";
            drawLivraisons(demandeData);
            drawEntrepot(demandeData.entrepot);

            const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');
            colisButton.style.filter = "";

            const fileNameCarte = document.getElementById('fileNameCarte');
            fileNameCarte.style.display = "none";
            const fileNameDemande = document.getElementById('fileNameDemande');
            fileNameDemande.style.display = "inline";
            document.getElementById('carte-chargee-message').style.display = "none";
            document.getElementById('calcul-tournee').style.display = "flex";
            document.getElementById('tournee-chargee').style.display = "none";

        }catch(err){
            alert(err.message);
        }
    }
  });

    function resetTournee(){
      if(window.tourneeLayer) window.tourneeLayer.clearLayers();
      if(window.directionNumbersLayer) window.directionNumbersLayer.clearLayers();
      stopAnimation();
      if(animControl){ map.removeControl(animControl); animControl=null; }
      animPath=[]; isAnimating=false; isPaused=false;
    }

    function drawCarte(c) {
  const n = c.noeuds || {}, t = c.troncons || [];
  const m = document.getElementById('map');
  m.style.display = "block";

  if (!map) {
    map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // crÃ©er les layers **une seule fois**
    livraisonsLayer = L.layerGroup().addTo(map);
    entrepotLayer = L.layerGroup().addTo(map);
    addLegend();
  }

  // Supprimer uniquement les tronÃ§ons de la carte prÃ©cÃ©dente
  if (window.tronconsLayer) window.tronconsLayer.clearLayers();
  else window.tronconsLayer = L.layerGroup().addTo(map);

  t.forEach(tc => {
    const o = n[tc.idOrigine], d = n[tc.idDestination];
    if (o && d) {
      L.polyline([[o.latitude, o.longitude], [d.latitude, d.longitude]], { color: '#1a74bb', weight: 2 })
       .addTo(window.tronconsLayer);
    }
  });

  const all = Object.values(n).map(x => [x.latitude, x.longitude]);
  if (all.length > 0) map.fitBounds(L.latLngBounds(all).pad(0.1));
}


    function drawLivraisons(d){
      if(!map||!carteData) return;
      livraisonsLayer.clearLayers();
      const n=carteData.noeuds;

      const tableau = document.getElementById("tableauDemandes");
      tableau.style.display = "block";
      tableau.innerHTML = "";
        const header = `
    <table style="border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid #ccc;padding:4px;">Couleur</th>
          <th style="border-bottom:1px solid #ccc;border-left:1px solid #ccc;padding:4px;">NÂ° d'enlÃ¨vement</th>
          <th style="border-bottom:1px solid #ccc;border-left:1px solid #ccc;padding:4px;">NÂ° de livraison</th>
        </tr>
      </thead>
      <tbody id="livraisonBody"></tbody>
    </table>
  `;
        tableau.innerHTML = header;
        const tbody = document.getElementById("livraisonBody");

        d.livraisons.forEach((l,i)=>{
        const color=colors[i%colors.length];
        const en=n[l.adresseEnlevement.id];
        const lv=n[l.adresseLivraison.id];
        if(!en||!lv) return;
        L.marker([en.latitude,en.longitude],{
          icon:L.divIcon({className:'',iconSize:[18,18],
            html:`<div style="width:18px;height:18px;background:${color};border:2px solid black;border-radius:3px;"></div>`})
        }).addTo(livraisonsLayer);
        L.marker([lv.latitude,lv.longitude],{
          icon:L.divIcon({className:'',iconSize:[18,18],
            html:`<div style="width:18px;height:18px;background:${color};border:2px solid black;border-radius:50%;"></div>`})
        }).addTo(livraisonsLayer);
            const row = document.createElement("tr");
            row.innerHTML = `
      <td style="padding:4px;text-align:center;">
        <div style="width:18px;height:18px;background:${color};border:1px solid black;border-radius:3px;margin:auto;"></div>
      </td>
      <td style="border-left:1px solid #ccc;padding:4px;text-align:center;">${l.adresseEnlevement.id}</td>
      <td style="border-left:1px solid #ccc;padding:4px;text-align:center;">${l.adresseLivraison.id}</td>
    `;
            tbody.appendChild(row);
      });
    }

    function drawEntrepot(e){
      if(!map||!e) return;
      entrepotLayer.clearLayers();
      L.marker([e.latitude,e.longitude],{
        icon:L.divIcon({className:'',iconSize:[24,24],
          html:`<svg width="24" height="24" viewBox="0 0 26 26">
                  <polygon points="13,3 23,23 3,23" fill="#000" stroke="black" stroke-width="2"/>
                </svg>`})
      }).addTo(entrepotLayer);
    }

    async function calculTournee(){
      if(!carteData||!demandeData){ alert("Charger la carte et la demande d'abord."); return; }
      const r=await fetch("http://localhost:8080/api/tournee/calculer",{method:"POST"});
      if(!r.ok){ alert(await r.text()); return; }
      const res=await r.json();
      t=res.tournee
      drawTournee(t);

      document.getElementById('tableauDemandes').style.display = "none";
      document.getElementById('livraisons').style.display = "none";
      document.getElementById('calcul-tournee').style.display = "none";

      document.getElementById('tournee-chargee').style.display = "inline";
    }


    function makeStepNumberIcon(n,color){
      const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="34" height="18" viewBox="0 0 34 18">
                    <text x="17" y="14" font-size="12" font-weight="bold" text-anchor="middle"
                          fill="${color}" stroke="white" stroke-width="3" paint-order="stroke">${n}</text>
                 </svg>`;
      return L.divIcon({className:'',html:svg,iconSize:[34,18]});
    }

    function midPoint(a,b){ return [(a[0]+b[0])/2,(a[1]+b[1])/2]; }

    function drawTournee(t){
      if(!map||!carteData) return;
      if(window.tourneeLayer) window.tourneeLayer.clearLayers(); else window.tourneeLayer=L.layerGroup().addTo(map);
      if(window.directionNumbersLayer) window.directionNumbersLayer.clearLayers(); else window.directionNumbersLayer=L.layerGroup().addTo(map);
      const n=carteData.noeuds, all=[], color='#000', K=6; let labelCount=0; animPath=[];
      t.chemins.forEach(c=>{
        const latlngs=[];
        c.troncons.forEach((tc,i)=>{
          const o=n[tc.idOrigine], d=n[tc.idDestination]; if(!o||!d) return;
          const A=[o.latitude,o.longitude], B=[d.latitude,d.longitude];
          latlngs.push(A); latlngs.push(B); all.push(A); all.push(B);
          if(i%K===0){ labelCount++; L.marker(midPoint(A,B),{icon:makeStepNumberIcon(labelCount,color)}).addTo(window.directionNumbersLayer); }
        });
        if(latlngs.length>0){
          L.polyline(latlngs,{color,weight:3,opacity:0.9}).addTo(window.tourneeLayer);
          animPath=animPath.concat(animPath.length>0&&animPath.at(-1)[0]===latlngs[0][0]?latlngs.slice(1):latlngs);
        }
      });
      if(all.length>0) map.fitBounds(L.latLngBounds(all).pad(0.1));
      addAnimationButton();
    }

    function samplePathMeters(path, stepM){
      if(path.length<2) return path.slice();
      const out=[]; let prev=L.latLng(path[0][0],path[0][1]); out.push([prev.lat,prev.lng]);
      for(let i=1;i<path.length;i++){
        const curr=L.latLng(path[i][0],path[i][1]); let segLen=map.distance(prev,curr);
        if(segLen===0){ prev=curr; continue; }
        for(let d=stepM; d<=segLen; d+=stepM){
          const t=d/segLen; const lat=prev.lat+(curr.lat-prev.lat)*t; const lng=prev.lng+(curr.lng-prev.lng)*t;
          out.push([lat,lng]);
        }
        prev=curr; if(Math.abs(out.at(-1)[0]-curr.lat)>1e-12) out.push([curr.lat,curr.lng]);
      }
      return out;
    }

    function startAnimation(){
      stopAnimation();
      if(animPath.length<2) return;
      animSamples=samplePathMeters(animPath,STEP_M); animIndex=0;
      courierMarker=L.marker(animSamples[0],{icon:L.divIcon({className:'',iconSize:[24,24],
        html:`<div style="font-size:20px;text-shadow:1px 1px 3px rgba(0,0,0,0.4);">ðŸ›µ</div>`})}).addTo(map);
      runAnimation();
    }

    function runAnimation(){
      const interval=50;
      animTimer=setInterval(()=>{
        if(animIndex>=animSamples.length-1){ stopAnimation(); return; }
        const metersPerFrame=animSpeed*(interval/1000); let next=animIndex+1;
        let dist=map.distance(L.latLng(animSamples[animIndex]),L.latLng(animSamples[next]));
        while(next<animSamples.length-1 && dist<metersPerFrame){ next++; dist+=map.distance(L.latLng(animSamples[next-1]),L.latLng(animSamples[next])); }
        animIndex=Math.min(next,animSamples.length-1); courierMarker.setLatLng(animSamples[animIndex]);
      },interval);
    }

    function pauseAnimation(){ if(animTimer){ clearInterval(animTimer); animTimer=null; } }
    function resumeAnimation(){ if(!animTimer) runAnimation(); }
    function stopAnimation(){ if(animTimer){ clearInterval(animTimer); animTimer=null; } if(courierMarker){ map.removeLayer(courierMarker); courierMarker=null; } }

    function addAnimationButton(){
      if(animControl){ map.removeControl(animControl); animControl=null; }
      animControl=L.control({position:'topleft'});
      animControl.onAdd=function(){
        const div=L.DomUtil.create('div','leaflet-bar leaflet-control leaflet-control-custom');
        div.innerHTML=`
          <div style="background:rgba(255,255,255,0.85);border-radius:10px;
                      box-shadow:0 0 5px rgba(0,0,0,0.3);padding:8px;
                      font-size:13px;text-align:center;width:160px;">
            <h4 style="margin:0 0 8px 0;font-weight:bold;">Livreur</h4>
            <button id="btnStartStop" style="background:#b2d1d2;border:none;padding:5px 8px;
                     border-radius:6px;cursor:pointer;width:100%;margin-bottom:5px;">Lancer lâ€™animation</button>
            <button id="btnPause" style="background:#ddd;border:none;padding:5px 8px;
                     border-radius:6px;cursor:pointer;width:100%;">Pause</button>
          </div>`;
        const start=div.querySelector('#btnStartStop'), pause=div.querySelector('#btnPause');
        start.onclick=e=>{
          e.stopPropagation();
          if(!isAnimating){ start.textContent='ArrÃªter lâ€™animation'; startAnimation(); isAnimating=true; pause.disabled=false; }
          else{ start.textContent='Lancer lâ€™animation'; stopAnimation(); isAnimating=false; isPaused=false; pause.textContent='Pause'; pause.disabled=true; }
        };
        pause.onclick=e=>{
          e.stopPropagation(); if(!isAnimating) return;
          if(!isPaused){ pauseAnimation(); isPaused=true; pause.textContent='Reprendre'; }
          else{ resumeAnimation(); isPaused=false; pause.textContent='Pause'; }
        };
        pause.disabled=true; return div;
      };
      animControl.addTo(map);
    }

    function addLegend(){
      const legend=L.control({position:'bottomleft'});
      legend.onAdd=function(){
        const div=L.DomUtil.create('div','legend');
        div.innerHTML=`
          <h4 style="margin:0 0 4px 0; text-align:center; font-weight:bold; font-size:12px;">LÃ©gende</h4>
          <div><svg width="16" height="16"><polygon points="8,2 14,14 2,14" fill="#000" stroke="black" stroke-width="2"/></svg> EntrepÃ´t</div>
          <div><div class="legend-symbol" style="background:#777;border:2px solid black;border-radius:3px;"></div> Pickup</div>
          <div><div class="legend-symbol" style="background:#777;border:2px solid black;border-radius:50%;"></div> Delivery</div>
          <div style="font-size:10px;color:#333;margin:3px 0;text-align:left;">Chaque couple Pickup / Delivery partage la mÃªme couleur</div>
          <div style="display:flex;align-items:center;"><div class="legend-symbol" style="width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:14px;">ðŸ›µ</div> Livreur</div>
          <div style="display:flex;align-items:center;"><svg width="32" height="16" viewBox="0 0 40 20" style="margin-right:4px;"><text x="16" y="13" font-size="12" font-weight="bold" text-anchor="middle" fill="#777" stroke="white" stroke-width="3" paint-order="stroke">1â€¦n</text></svg> Sens de la tournÃ©e</div>`;
        return div;
      };
      legend.addTo(map);
    }

    document.addEventListener('DOMContentLoaded',()=>{
        const inputCarte = document.getElementById('xmlCarte');
        const inputDemande = document.getElementById('xmlDemande');

        const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');
        const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');

        mapButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";
        mapButton.addEventListener('click', () => {
            inputCarte.click();
        });
        colisButton.addEventListener('click', () => {
            if (!inputDemande.disabled) {
                inputDemande.click();
            }
        });

        document.getElementById('xmlCarte').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('fileNameCarte').textContent = file ? `Affichage de ${file.name}` : "";
            if (file) uploadCarte(file);
        });

        document.getElementById('xmlDemande').addEventListener('change', function() {
            const file = this.files[0];
            document.getElementById('fileNameDemande').textContent = file ? `Affichage de ${file.name}` : "";
            if (file) uploadDemande(file);
        });

        document.getElementById('homeButton').addEventListener('click', () => {
            const confirmReset = confirm("Voulez-vous vraiment revenir Ã  la page dâ€™accueil ? Toutes les donnÃ©es chargÃ©es seront perdues.");

            if (confirmReset) {
                carteData = null;
                map = null;

                const mapDiv = document.getElementById('map');
                mapDiv.style.display = "none";
                mapDiv.innerHTML = "";

                document.getElementById('xmlCarte').value = "";
                document.getElementById('xmlDemande').value = "";
                document.getElementById('xmlDemande').disabled = true;

                document.getElementById('fileNameCarte').style.display = "none";
                document.getElementById('fileNameDemande').style.display = "none";
                document.getElementById('carte-chargee-message').style.display = "none";
                document.getElementById('welcome-message').style.display = "flex";

                tableau = document.getElementById('tableauDemandes');
                tableau.style.display = "none";
                tableau.innerHTML = "";

                const mapButton = document.querySelector('.navbar-item img[alt="Ajouter une carte"]');
                const colisButton = document.querySelector('.navbar-item img[alt="Ajouter une demande de livraison"]');

                mapButton.style.filter = "drop-shadow(0 0 10px rgba(225,225,0,1))";
                colisButton.src = "tools/colis-logo-gray.png";
                colisButton.style.filter = "";
                colisButton.style.cursor = "default";

                document.getElementById('calcul-tournee').style.display = "none";
                document.getElementById('tournee-chargee').style.display = "none";
            }
        });

        document.getElementById('calculerTournee').addEventListener('click', () => {
            calculTournee();
        });

    });
</script>
</body>
</html>